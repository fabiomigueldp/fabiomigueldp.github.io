<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modern Utilities</title>
  <!-- 
    1) We're using the "Inter" font (a clean, modern sans-serif). 
    2) Fallback to system sans-serif if Inter is unavailable.
  -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
  <style>
    /* 
      ===============================
      GLOBAL VARIABLES & RESET
      ===============================
    */
    :root {
      /* Color Palette */
      --background: #000000;
      --surface: #1a1a1a;          /* Secondary dark surface */
      --card-bg: #1f1f1f;          /* Slightly lighter than surface for cards */
      --text-color: #eeeeee;       /* Main text color (light gray) */
      --border-color: #333333;     /* Thin border/outlines */
      --accent-color: #0A84FF;     /* Single accent color for interactive elements */

      /* Typography */
      --font-family: 'Inter', sans-serif;
      --font-size-base: 16px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --line-height-base: 1.4;

      /* Spacing & Layout */
      --spacing: 16px;
      --border-radius: 14px;       /* Increased curvature for a modern look */
      --button-radius: 12px;
      --transition-base: 0.3s ease;/* Smooth transitions */

      /* Shadows */
      --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.3); 
      --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      background-color: var(--background);
      color: var(--text-color);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: var(--line-height-base);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    .container {
      width: 100%;
      max-width: 960px;
      display: flex;
      flex-direction: column;
      gap: var(--spacing);
    }

    /* 
      ===============================
      TABS & NAVIGATION
      ===============================
    */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .tab-button {
      background-color: var(--surface);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: var(--button-radius);
      padding: 10px 24px;
      font-size: 15px;
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: background-color var(--transition-base),
                  transform var(--transition-base),
                  box-shadow var(--transition-base);
    }

    .tab-button:hover {
      background-color: #2a2a2a;
      box-shadow: var(--shadow-hover);
      transform: translateY(-1px);
    }

    .tab-button.active {
      background-color: var(--accent-color);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: var(--shadow-hover);
      border-color: var(--accent-color);
    }

    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* 
      ===============================
      TEXT AREA & COMMON BUTTONS
      ===============================
    */
    .text-area {
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 16px;
      font-size: 15px;
      min-height: 120px;
      width: 100%;
      resize: vertical;
      transition: border var(--transition-base), box-shadow var(--transition-base);
    }

    .text-area:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.4);
    }

    .text-area::placeholder {
      color: #999999;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .button {
      background-color: var(--surface);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 10px 24px;
      font-size: 15px;
      border-radius: var(--button-radius);
      cursor: pointer;
      transition: background-color var(--transition-base),
                  transform var(--transition-base),
                  box-shadow var(--transition-base);
    }

    .button:hover {
      background-color: #2a2a2a;
      box-shadow: var(--shadow-hover);
      transform: translateY(-1px);
    }

    /* For primary actions */
    .button.primary {
      background-color: var(--accent-color);
      color: #ffffff;
      border: none;
    }
    .button.primary:hover {
      background-color: rgba(10,132,255,0.85);
      transform: translateY(-1px);
      box-shadow: var(--shadow-hover);
    }

    /* 
      ===============================
      RESULT AREA
      ===============================
    */
    .result-area {
      margin-top: var(--spacing);
      padding: 16px;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-color);
      white-space: pre-wrap;
      word-wrap: break-word;
      min-height: 120px;
      display: none;
    }

    /* 
      ===============================
      PROJECT UTILITY
      ===============================
    */
    #projectUtility * {
      box-sizing: border-box;
    }

    #projectUtility .container {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: var(--spacing);
    }

    /* Header and internal nav */
    #projectUtility header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: var(--spacing);
      border-bottom: 1px solid var(--border-color);
    }

    #projectUtility header h1 {
      font-size: 1.4rem;
      margin: 0;
      font-weight: var(--font-weight-semibold);
    }

    #projectUtility nav {
      display: flex;
      gap: var(--spacing);
    }

    #projectUtility main {
      margin-top: var(--spacing);
    }

    #projectUtility .section {
      display: none;
      animation: fadeIn var(--transition-base);
    }

    #projectUtility .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.98);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Form container */
    #projectUtility .form-container {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-elevation);
      padding: var(--spacing);
      margin-bottom: var(--spacing);
    }

    #projectUtility .form-container h2 {
      margin-top: 0;
      font-size: 1.2rem;
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--spacing);
    }

    .form-group {
      margin-bottom: var(--spacing);
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.95rem;
      font-weight: var(--font-weight-medium);
    }

    .form-group input[type="text"],
    .form-group textarea,
    .form-group input[type="file"] {
      width: 100%;
      padding: 10px;
      background-color: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-color);
      font-size: 15px;
      transition: border var(--transition-base), box-shadow var(--transition-base);
    }

    .form-group input[type="text"]:focus,
    .form-group textarea:focus,
    .form-group input[type="file"]:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.4);
    }

    /* Attachments container */
    #current-attachments-container {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing);
      margin-top: calc(var(--spacing) / 2);
    }

    .current-attachment {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 100px;
      background-color: var(--surface);
      padding: 8px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-elevation);
    }

    .current-attachment img {
      width: 100%;
      border-radius: var(--border-radius);
      margin-bottom: 4px;
    }

    .remove-attachment {
      background: #ff3b30;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: var(--button-radius);
      transition: background var(--transition-base), transform var(--transition-base);
    }

    .remove-attachment:hover {
      background: rgba(255, 59, 48, 0.8);
      transform: translateY(-1px);
    }

    /* 
      ===============================
      SEARCH BAR
      ===============================
    */
    .search-container {
      position: relative;
      margin-bottom: var(--spacing);
    }

    .search-container input[type="text"] {
      width: 100%;
      padding: 10px 40px 10px 48px;
      background-color: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-color);
      font-size: 15px;
      transition: box-shadow var(--transition-base), border var(--transition-base);
    }

    .search-container input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.4);
    }

    .search-container svg {
      position: absolute;
      top: 50%;
      left: 14px;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      fill: #666666;
    }

    /* 
      ===============================
      PROJECT CARDS
      ===============================
    */
    .projects-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing);
    }

    .project-card {
      background-color: var(--card-bg);
      padding: var(--spacing);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-elevation);
      transition: transform var(--transition-base), box-shadow var(--transition-base);
      cursor: pointer;
    }

    .project-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .project-card h3 {
      margin: 0 0 4px;
      font-size: 1.05rem;
      font-weight: var(--font-weight-medium);
    }

    .project-card p {
      margin: 4px 0;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .attachments-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .icon {
      vertical-align: middle;
      width: 16px;
      height: 16px;
      fill: var(--text-color);
    }

    /* 
      ===============================
      MODAL
      ===============================
    */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      padding: var(--spacing);
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      max-width: 600px;
      width: 100%;
      padding: var(--spacing);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-hover);
      border: 1px solid var(--border-color);
    }

    .modal-content h2 {
      margin-top: 0;
      font-size: 1.2rem;
      font-weight: var(--font-weight-semibold);
    }

    .close-button {
      position: absolute;
      top: var(--spacing);
      right: var(--spacing);
      background: var(--accent-color);
      border: none;
      color: #ffffff;
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: var(--button-radius);
      cursor: pointer;
      transition: background var(--transition-base), transform var(--transition-base);
    }

    .close-button:hover {
      background: rgba(10,132,255,0.85);
      transform: translateY(-1px);
    }

    .modal-section {
      margin-bottom: var(--spacing);
    }

    .attachments {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing);
    }

    .attachment {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 100px;
      background-color: var(--surface);
      padding: 8px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-elevation);
    }

    .attachment img {
      width: 100%;
      border-radius: var(--border-radius);
      margin-bottom: 4px;
    }

    .attachment a {
      color: var(--accent-color);
      font-size: 0.8rem;
      text-decoration: none;
    }

    /* 
      ===============================
      COVER LETTER STYLES
      ===============================
    */
    .cover-letter-list {
      margin-bottom: var(--spacing);
    }

    .cover-letter-list li {
      display: flex;
      align-items: center;
      gap: var(--spacing);
      font-size: 0.9rem;
      color: var(--text-color);
      padding: calc(var(--spacing) / 2) var(--spacing);
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-elevation);
      margin-bottom: 8px;
    }

    .cover-letter-list input[type="checkbox"] {
      transform: scale(1.2);
    }

    .cover-letter-result textarea {
      width: 100%;
      height: 200px;
      padding: var(--spacing);
      background-color: var(--surface);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-color);
      font-size: 0.9rem;
      box-shadow: var(--shadow-elevation);
      resize: none;
      transition: box-shadow var(--transition-base), border var(--transition-base);
    }

    .cover-letter-result textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.4);
    }

    #cover-letter-attachments-grid {
      margin-top: var(--spacing);
    }

    /* 
      ===============================
      RESPONSIVE DESIGN
      ===============================
    */
    @media (max-width: 768px) {
      .container {
        width: 95%;
      }
      .tab-button {
        font-size: 14px;
        padding: 8px 16px;
      }
      .button {
        font-size: 14px;
        padding: 8px 16px;
      }
      .text-area {
        padding: 12px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .container {
        width: 98%;
      }
      .tab-button {
        font-size: 12px;
        padding: 6px 12px;
      }
      .button {
        font-size: 12px;
        padding: 6px 12px;
      }
      .text-area {
        padding: 10px;
        font-size: 12px;
      }
      #projectUtility header {
        flex-direction: column;
        align-items: flex-start;
      }
      #projectUtility nav {
        margin-top: var(--spacing);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- TABS -->
    <div class="tabs">
      <!-- Removed "Utilities Hub" text as required -->
      <button class="tab-button active" onclick="openTab(event, 'textCondenser')">Text Condenser</button>
      <button class="tab-button" onclick="openTab(event, 'textArea')">Text Area</button>
      <button class="tab-button" onclick="openTab(event, 'projectUtility')">Project Utility</button>
    </div>

    <!-- TAB CONTENT: Text Condenser -->
    <div id="textCondenser" class="tab-content active">
      <div id="text-fields">
        <textarea class="text-area" placeholder="Paste your text here..."></textarea>
      </div>
      <div class="button-group">
        <button class="button" onclick="addTextField()">Add Text Field</button>
        <button class="button" onclick="condenseTexts()">Condense</button>
        <button class="button" onclick="copyResult('textCondenserResult')">Copy Result</button>
        <button class="button" onclick="clearAll('textCondenser')">Clear</button>
      </div>
      <div id="textCondenserResult" class="result-area"></div>
    </div>

    <!-- TAB CONTENT: Text Area -->
    <div id="textArea" class="tab-content">
      <div id="simple-text-area">
        <textarea id="textInput" class="text-area" placeholder="Paste your text here..." autofocus></textarea>
      </div>
      <div class="button-group">
        <button class="button" onclick="copyResult('textInput')">Copy Text</button>
        <button class="button" onclick="clearText('textInput')">Clear Text</button>
      </div>
    </div>

    <!-- TAB CONTENT: Project Utility -->
    <div id="projectUtility" class="tab-content">
      <div class="container">
        <!-- Header with internal navigation -->
        <header>
          <h1>Projects & Cover Letter</h1>
          <div>
            <nav>
              <button id="tab-projects" class="button active">Projects</button>
              <button id="tab-cover-letter" class="button">Cover Letter</button>
            </nav>
            <button id="select-folder" class="button">Select Folder</button>
          </div>
        </header>
        <main>
          <!-- SECTION: Projects -->
          <section id="projects-section" class="section active">
            <div class="form-container">
              <h2>New Project</h2>
              <form id="project-form">
                <!-- Hidden field for editing -->
                <input type="hidden" id="project-id" />
                <div class="form-group">
                  <label for="project-title">Title</label>
                  <input type="text" id="project-title" placeholder="Enter project title" required />
                </div>
                <div class="form-group">
                  <label for="project-description">Description</label>
                  <textarea
                    id="project-description"
                    placeholder="Describe the project"
                    required
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="project-competencies">Competencies (comma-separated)</label>
                  <input
                    type="text"
                    id="project-competencies"
                    placeholder="Ex: JavaScript, Node.js, React"
                  />
                </div>
                <div class="form-group">
                  <label for="project-attachments">Attachments (files/images)</label>
                  <input type="file" id="project-attachments" multiple />
                  <div id="current-attachments-container"></div>
                </div>
                <div class="form-group">
                  <label for="project-link-url">Resource Link (URL)</label>
                  <input type="text" id="project-link-url" placeholder="https://example.com" />
                </div>
                <div class="form-group">
                  <label for="project-link-desc">Link Description</label>
                  <input type="text" id="project-link-desc" placeholder="Link description" />
                </div>
                <button type="submit" class="button primary">Save Project</button>
              </form>
            </div>

            <!-- Search bar -->
            <div class="search-container">
              <svg viewBox="0 0 24 24">
                <path d="M10,18a8,8 0 1,1 8-8a8,8 0 0,1 -8,8M22,22l-4.35-4.35"></path>
              </svg>
              <input type="text" id="search-input" placeholder="Search projects..." />
            </div>

            <!-- Projects list (cards) -->
            <div class="projects-list" id="projects-list"></div>
          </section>

          <!-- SECTION: Cover Letter -->
          <section id="cover-letter-section" class="section">
            <h2>Cover Letter Composer</h2>
            <ul class="cover-letter-list" id="cover-letter-projects-list"></ul>
            <button id="generate-cover-letter" class="button primary">Generate Cover Letter</button>

            <div class="cover-letter-result" style="margin-top: var(--spacing);">
              <textarea
                id="cover-letter-text"
                class="text-area"
                readonly
                placeholder="Your cover letter will appear here..."
              ></textarea>
              <div
                class="button-group"
                style="margin-top: var(--spacing); justify-content: flex-start;"
              >
                <button id="copy-cover-letter" class="button primary">Copy to Clipboard</button>
              </div>
            </div>
            <div id="cover-letter-attachments-grid"></div>
          </section>
        </main>
      </div>

      <!-- Modal for Project Details -->
      <div class="modal" id="project-modal">
        <div class="modal-content">
          <button class="close-button" id="modal-close">Done</button>
          <div id="modal-body">
            <!-- Project details injected via JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 
    ===============================
    JAVASCRIPT 
    ===============================
    All functionality remains intact, 
    only styles have been enhanced.
  -->
  <script>
    // Global Variables
    let projects = [];
    let dataFolderHandle = null;
    let currentEditingAttachments = [];

    // Generates a unique ID for each project
    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    // Select data folder (File System Access API)
    async function selectDataFolder() {
      try {
        dataFolderHandle = await window.showDirectoryPicker();
        alert('Folder selected successfully!');
        await loadProjectsFromFile();
      } catch (err) {
        console.error('Error selecting folder:', err);
      }
    }

    // Load projects from JSON file or fallback to localStorage
    async function loadProjectsFromFile() {
      if (dataFolderHandle) {
        try {
          const fileHandle = await dataFolderHandle.getFileHandle('projetos_data.json', { create: false });
          const file = await fileHandle.getFile();
          const contents = await file.text();
          projects = JSON.parse(contents);
          renderProjects();
          return;
        } catch (err) {
          console.warn('Data file not found. Using localStorage.');
        }
      }
      const data = localStorage.getItem('projects');
      projects = data ? JSON.parse(data) : [];
      renderProjects();
    }

    // Save projects to localStorage and file if folder is selected
    async function saveProjects() {
      localStorage.setItem('projects', JSON.stringify(projects));
      if (dataFolderHandle) {
        await saveDataToFile();
      }
    }

    // Save data to JSON file in selected folder
    async function saveDataToFile() {
      try {
        const fileHandle = await dataFolderHandle.getFileHandle('projetos_data.json', { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(projects, null, 2));
        await writable.close();
      } catch (err) {
        console.error('Error saving data to file:', err);
      }
    }

    // Render projects as cards
    function renderProjects(filter = '') {
      const list = document.getElementById('projects-list');
      list.innerHTML = '';
      const filtered = projects.filter(p =>
        p.title.toLowerCase().includes(filter.toLowerCase()) ||
        p.description.toLowerCase().includes(filter.toLowerCase())
      );
      filtered.forEach(project => {
        const card = document.createElement('div');
        card.className = 'project-card';
        card.addEventListener('click', () => openProjectModal(project.id));
        const fileCount = project.attachments
          ? project.attachments.filter(att => att.type === 'file').length
          : 0;
        card.innerHTML = `
          <h3>${project.title}</h3>
          <p>${truncateText(project.description, 100)}</p>
          ${
            fileCount > 0
              ? `
            <div class="attachments-indicator">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M18.5,6.5a5,5 0 0,0-7.07,0l-5.66,5.66a3,3 0 0,0 4.24,4.24l6.36-6.36a1,1 0 1,0-1.41-1.41l-6.36,6.36a1,1 0 1,1-1.41-1.41l5.66-5.66a3,3 0 1,1 4.24,4.24l-6.36,6.36"></path>
              </svg>
              <span>${fileCount}</span>
            </div>`
              : ''
          }
        `;
        list.appendChild(card);
      });
      renderCoverLetterList();
    }

    // Truncate text if it exceeds the limit
    function truncateText(text, maxLength) {
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Render cover letter project list (checkboxes)
    function renderCoverLetterList() {
      const ul = document.getElementById('cover-letter-projects-list');
      ul.innerHTML = '';
      projects.forEach(project => {
        const li = document.createElement('li');
        li.innerHTML = `
          <input type="checkbox" data-id="${project.id}" />
          <span>${project.title}</span>
        `;
        ul.appendChild(li);
      });
    }

    // Render attachments currently being edited
    function renderCurrentAttachments() {
      const container = document.getElementById('current-attachments-container');
      container.innerHTML = '';
      currentEditingAttachments.forEach((att, index) => {
        if (att.type === 'file') {
          const attDiv = document.createElement('div');
          attDiv.className = 'current-attachment';
          if (att.mime && att.mime.startsWith('image/')) {
            attDiv.innerHTML = `<img src="${att.data}" alt="${att.name}" />`;
          } else {
            attDiv.innerHTML = `
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M14,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2Z"></path>
              </svg>
              <span>${att.name}</span>
            `;
          }
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-attachment';
          removeBtn.textContent = 'Remove';
          removeBtn.onclick = () => {
            currentEditingAttachments.splice(index, 1);
            renderCurrentAttachments();
          };
          attDiv.appendChild(removeBtn);
          container.appendChild(attDiv);
        }
      });
    }

    // Clear form fields
    function clearForm() {
      document.getElementById('project-id').value = '';
      document.getElementById('project-title').value = '';
      document.getElementById('project-description').value = '';
      document.getElementById('project-competencies').value = '';
      document.getElementById('project-link-url').value = '';
      document.getElementById('project-link-desc').value = '';
      document.getElementById('project-attachments').value = '';
      currentEditingAttachments = [];
      renderCurrentAttachments();
    }

    // Handle file input changes
    document.getElementById('project-attachments').addEventListener('change', async function(e) {
      const files = e.target.files;
      if (files.length > 0) {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const data = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = ev => resolve(ev.target.result);
            reader.readAsDataURL(file);
          });
          currentEditingAttachments.push({
            type: 'file',
            name: file.name,
            data: data,
            mime: file.type
          });
        }
        renderCurrentAttachments();
        e.target.value = "";
      }
    });

    // Save or update project
    document.getElementById('project-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const idField = document.getElementById('project-id');
      const title = document.getElementById('project-title').value.trim();
      const description = document.getElementById('project-description').value.trim();
      const competencies = document
        .getElementById('project-competencies')
        .value.split(',')
        .map(c => c.trim())
        .filter(c => c);
      const linkUrl = document.getElementById('project-link-url').value.trim();
      const linkDesc = document.getElementById('project-link-desc').value.trim();

      // Remove existing links and add new if provided
      currentEditingAttachments = currentEditingAttachments.filter(att => att.type !== 'link');
      if (linkUrl !== "") {
        currentEditingAttachments.push({ type: 'link', url: linkUrl, desc: linkDesc });
      }

      if (idField.value) {
        const index = projects.findIndex(p => p.id === idField.value);
        if (index > -1) {
          projects[index] = {
            ...projects[index],
            title,
            description,
            competencies,
            attachments: currentEditingAttachments
          };
        }
      } else {
        const newProject = {
          id: generateId(),
          title,
          description,
          competencies,
          attachments: currentEditingAttachments
        };
        projects.push(newProject);
      }
      await saveProjects();
      renderProjects();
      clearForm();
    });

    // Open modal with project details
    function openProjectModal(id) {
      const project = projects.find(p => p.id === id);
      if (!project) return;
      const modal = document.getElementById('project-modal');
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <h2>${project.title}</h2>
        <p>${project.description}</p>
        ${
          project.competencies && project.competencies.length
            ? `<p><strong>Competencies:</strong> ${project.competencies.join(', ')}</p>`
            : ''
        }
        ${
          project.attachments && project.attachments.some(att => att.type === 'link')
            ? (() => {
                const linkObj = project.attachments.find(att => att.type === 'link');
                return `<p><strong>Link:</strong> ${linkObj.desc} (${linkObj.url})</p>`;
              })()
            : ''
        }
        ${
          project.attachments && project.attachments.some(att => att.type === 'file')
            ? renderAttachments(project.attachments)
            : ''
        }
        <div style="margin-top: var(--spacing);">
          <button class="button primary" onclick="editProject('${project.id}'); closeModal();">Edit</button>
          <button class="button primary" style="background-color: #ff3b30;" onclick="deleteProject('${project.id}'); closeModal();">Delete</button>
        </div>
      `;
      modal.classList.add('active');
    }

    // Render file attachments in the modal
    function renderAttachments(attachments) {
      let html = '<div class="modal-section"><h3>Attachments</h3><div class="attachments">';
      attachments.forEach(att => {
        if (att.type === 'file') {
          if (att.mime && att.mime.startsWith('image/')) {
            html += `
              <div class="attachment">
                <img src="${att.data}" alt="${att.name}" />
                <a href="${att.data}" download="${att.name}">${att.name}</a>
              </div>
            `;
          } else {
            html += `
              <div class="attachment">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M14,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2Z"></path>
                </svg>
                <a href="${att.data}" download="${att.name}">${att.name}</a>
              </div>
            `;
          }
        }
      });
      html += '</div></div>';
      return html;
    }

    function closeModal() {
      document.getElementById('project-modal').classList.remove('active');
    }

    function editProject(id) {
      const project = projects.find(p => p.id === id);
      if (project) {
        document.getElementById('project-id').value = project.id;
        document.getElementById('project-title').value = project.title;
        document.getElementById('project-description').value = project.description;
        document.getElementById('project-competencies').value = project.competencies.join(', ');
        const linkObj = project.attachments
          ? project.attachments.find(att => att.type === 'link')
          : null;
        if (linkObj) {
          document.getElementById('project-link-url').value = linkObj.url;
          document.getElementById('project-link-desc').value = linkObj.desc;
        } else {
          document.getElementById('project-link-url').value = "";
          document.getElementById('project-link-desc').value = "";
        }
        currentEditingAttachments = project.attachments ? [...project.attachments] : [];
        renderCurrentAttachments();
      }
    }

    async function deleteProject(id) {
      if (confirm('Are you sure you want to delete this project?')) {
        projects = projects.filter(p => p.id !== id);
        await saveProjects();
        renderProjects();
      }
    }

    // Generate Cover Letter
    document.getElementById('generate-cover-letter').addEventListener('click', function() {
      const selected = [];
      document
        .querySelectorAll('#cover-letter-projects-list input[type="checkbox"]')
        .forEach(chk => {
          if (chk.checked) {
            const proj = projects.find(p => p.id === chk.dataset.id);
            if (proj) selected.push(proj);
          }
        });
      if (selected.length === 0) {
        alert('Select at least one project to generate a cover letter.');
        return;
      }
      let coverLetter = "Cover Letter\n\n";
      selected.forEach(proj => {
        coverLetter += `Project: ${proj.title}\n`;
        coverLetter += `Description: ${proj.description}\n`;
        if (proj.competencies && proj.competencies.length) {
          coverLetter += `Competencies: ${proj.competencies.join(', ')}\n`;
        }
        if (proj.attachments && proj.attachments.some(att => att.type === 'link')) {
          const linkObj = proj.attachments.find(att => att.type === 'link');
          coverLetter += `Link: ${linkObj.desc} (${linkObj.url})\n`;
        }
        if (proj.attachments && proj.attachments.some(att => att.type === 'file')) {
          coverLetter += `Attachments: `;
          proj.attachments.filter(att => att.type === 'file').forEach(att => {
            coverLetter += `${att.name} `;
          });
          coverLetter += `\n`;
        }
        coverLetter += "\n";
      });
      document.getElementById('cover-letter-text').value = coverLetter;
      renderCoverLetterAttachmentsByProject(selected);
    });

    // Render attachments grid by project in Cover Letter
    function renderCoverLetterAttachmentsByProject(selectedProjects) {
      const grid = document.getElementById('cover-letter-attachments-grid');
      grid.innerHTML = '';
      selectedProjects.forEach(proj => {
        const fileAttachments = (proj.attachments || []).filter(att => att.type === 'file');
        if (fileAttachments.length > 0) {
          const projContainer = document.createElement('div');
          projContainer.style.marginBottom = "var(--spacing)";
          const header = document.createElement('h3');
          header.textContent = proj.title;
          header.style.fontSize = "1rem";
          header.style.marginBottom = "8px";
          projContainer.appendChild(header);

          const attachmentGrid = document.createElement('div');
          attachmentGrid.style.display = "grid";
          attachmentGrid.style.gridTemplateColumns = "repeat(auto-fit, minmax(100px, 1fr))";
          attachmentGrid.style.gap = "var(--spacing)";

          fileAttachments.forEach(att => {
            const attDiv = document.createElement('div');
            attDiv.className = "attachment";
            if (att.mime && att.mime.startsWith('image/')) {
              attDiv.innerHTML = `
                <img src="${att.data}" alt="${att.name}" />
                <span style="font-size: 0.8rem; text-align: center;">${att.name}</span>
              `;
            } else {
              attDiv.innerHTML = `
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M14,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2Z"></path>
                </svg>
                <span style="font-size: 0.8rem; text-align: center;">${att.name}</span>
              `;
            }
            attDiv.onclick = () => {
              const a = document.createElement("a");
              a.href = att.data;
              a.download = att.name;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            };
            attachmentGrid.appendChild(attDiv);
          });
          projContainer.appendChild(attachmentGrid);
          grid.appendChild(projContainer);
        }
      });
    }

    // Copy Cover Letter
    document.getElementById('copy-cover-letter').addEventListener('click', function() {
      const textarea = document.getElementById('cover-letter-text');
      textarea.select();
      document.execCommand('copy');
      alert('Cover letter copied!');
    });

    // Internal tab controls (within Project Utility)
    document.getElementById('tab-projects').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('tab-cover-letter').classList.remove('active');
      document.getElementById('projects-section').classList.add('active');
      document.getElementById('cover-letter-section').classList.remove('active');
    });

    document.getElementById('tab-cover-letter').addEventListener('click', function() {
      this.classList.add('active');
      document.getElementById('tab-projects').classList.remove('active');
      document.getElementById('cover-letter-section').classList.add('active');
      document.getElementById('projects-section').classList.remove('active');
      renderCoverLetterList();
    });

    document.getElementById('search-input').addEventListener('input', function() {
      renderProjects(this.value);
    });

    document.getElementById('select-folder').addEventListener('click', selectDataFolder);

    document.getElementById('modal-close').addEventListener('click', closeModal);

    // Main tab switching (Text Condenser / Text Area / Project Utility)
    function openTab(evt, tabName) {
      let tabcontent = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
      }
      let tabbuttons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].classList.remove("active");
      }
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");

      if (tabName === 'projectUtility') {
        initProjectUtility();
      }
    }

    // Text Condenser Functions
    function addTextField() {
      const textFields = document.getElementById('text-fields');
      const newTextArea = document.createElement('textarea');
      newTextArea.className = 'text-area';
      newTextArea.placeholder = 'Paste your text here...';
      textFields.appendChild(newTextArea);
    }

    function condenseTexts() {
      const textAreas = document.querySelectorAll('#textCondenser .text-area');
      let combinedText = '';
      textAreas.forEach((textArea, index) => {
        const text = textArea.value.trim();
        if (text) {
          combinedText += `Text ${index + 1}:\n${text}\n\n---\n\n`;
        }
      });
      const resultArea = document.getElementById('textCondenserResult');
      resultArea.textContent = combinedText || 'No text to condense.';
      resultArea.style.display = 'block';
    }

    function clearAll(tabId) {
      if (tabId === 'textCondenser') {
        const textFields = document.getElementById('text-fields');
        textFields.innerHTML = '<textarea class="text-area" placeholder="Paste your text here..."></textarea>';
        const resultArea = document.getElementById('textCondenserResult');
        resultArea.textContent = '';
        resultArea.style.display = 'none';
      }
    }

    function clearText(textAreaId) {
      document.getElementById(textAreaId).value = '';
    }

    function copyResult(resultElementId) {
      const resultArea = document.getElementById(resultElementId);
      const textToCopy = resultArea.value !== undefined ? resultArea.value : resultArea.textContent;
      navigator.clipboard
        .writeText(textToCopy)
        .then(() => {
          alert('Result copied to clipboard!');
        })
        .catch(err => {
          console.error('Error copying text: ', err);
        });
    }

    // Initialize Project Utility
    function initProjectUtility() {
      loadProjectsFromFile();
      renderProjects();
    }

    // On DOM load
    document.addEventListener('DOMContentLoaded', function() {
      openTab(event, 'textCondenser'); 
      initProjectUtility();
    });
  </script>
</body>
</html>

